{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏ä‡πà‡∏≤‡∏á) - TU Report{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏ä‡πà‡∏≤‡∏á)</h1>

    <!-- Availability Toggle -->
    <form method="post" action="{% url 'technician:update_availability' %}" class="inline">
      {% csrf_token %}
      <button type="submit" class="px-6 py-3 rounded-lg font-semibold transition-all {% if is_available %}bg-green-600 hover:bg-green-700 text-white{% else %}bg-gray-400 hover:bg-gray-500 text-white{% endif %}">
        {% if is_available %}
          ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
        {% else %}
          ‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
        {% endif %}
      </button>
    </form>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
      <div class="text-sm text-yellow-600 font-medium">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
      <div class="text-3xl font-bold text-yellow-700">{{ pending_count }}</div>
    </div>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="text-sm text-blue-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
      <div class="text-3xl font-bold text-blue-700">{{ in_progress_count }}</div>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á</h2>
    <form method="get" class="space-y-4">
      <!-- Search Bar -->
      <div>
        <input type="text" name="search" value="{{ search_query }}" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."
               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
      </div>

      <!-- Filters Grid -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Status Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="IN_PROGRESS" {% if status_filter == 'IN_PROGRESS' %}selected{% endif %}>‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="INSPECTING" {% if status_filter == 'INSPECTING' %}selected{% endif %}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
            <option value="WORKING" {% if status_filter == 'WORKING' %}selected{% endif %}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="COMPLETED" {% if status_filter == 'COMPLETED' %}selected{% endif %}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>
        </div>

        <!-- Category Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}" {% if category_filter == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Urgency Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
          <select name="urgency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="LOW" {% if urgency_filter == 'LOW' %}selected{% endif %}>‡∏ï‡πà‡∏≥</option>
            <option value="NORMAL" {% if urgency_filter == 'NORMAL' %}selected{% endif %}>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
            <option value="HIGH" {% if urgency_filter == 'HIGH' %}selected{% endif %}>‡∏™‡∏π‡∏á</option>
            <option value="CRITICAL" {% if urgency_filter == 'CRITICAL' %}selected{% endif %}>‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          </select>
        </div>

        <!-- Sort -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</label>
          <select name="sort" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
            <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
            <option value="-urgency_level" {% if sort_by == '-urgency_level' %}selected{% endif %}>‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î</option>
            <option value="urgency_level" {% if sort_by == 'urgency_level' %}selected{% endif %}>‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î</option>
          </select>
        </div>
      </div>

      <!-- Date Range -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
          <input type="date" name="date_from" value="{{ date_from }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
          <input type="date" name="date_to" value="{{ date_to }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex gap-3">
        <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
          üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
        <a href="{% url 'technician:job_list' %}" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
          üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        </a>
        {% if search_query or status_filter or category_filter or urgency_filter or date_from or date_to %}
        <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-md text-sm">
          ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: {{ filtered_count }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </span>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="mb-4 p-3 rounded {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Jobs Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for ticket in assigned_tickets %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#{{ ticket.id }}</td>
          <td class="px-6 py-4 text-sm text-gray-900">{{ ticket.title }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ticket.category.name }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            {% if ticket.urgency_level == 'LOW' %}
              <span class="text-green-600">‡∏ï‡πà‡∏≥</span>
            {% elif ticket.urgency_level == 'MEDIUM' %}
              <span class="text-yellow-600">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
            {% elif ticket.urgency_level == 'HIGH' %}
              <span class="text-orange-600">‡∏™‡∏π‡∏á</span>
            {% elif ticket.urgency_level == 'CRITICAL' %}
              <span class="text-red-600">‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if ticket.status == 'PENDING' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
            {% elif ticket.status == 'IN_PROGRESS' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
            {% elif ticket.status == 'INSPECTING' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
            {% elif ticket.status == 'WORKING' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
            {% elif ticket.status == 'COMPLETED' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ticket.created_by.get_display_name }}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
            <a href="{% url 'tickets:ticket_detail' ticket.id %}" class="inline-block px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
