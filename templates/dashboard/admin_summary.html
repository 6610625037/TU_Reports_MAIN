{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - TU Report{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">üìä Admin Dashboard</h1>
    <p class="text-sm text-gray-600 mt-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</p>
  </div>

  <!-- Overview Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Tickets -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Total Tickets</p>
          <p class="text-3xl font-bold text-gray-800 mt-2">{{ total_tickets }}</p>
        </div>
        <div class="text-4xl">üé´</div>
      </div>
    </div>

    <!-- Pending -->
    <div class="bg-yellow-50 rounded-lg shadow p-6 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-yellow-800">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
          <p class="text-3xl font-bold text-yellow-900 mt-2">{{ pending_tickets }}</p>
        </div>
        <div class="text-4xl">‚è≥</div>
      </div>
    </div>

    <!-- In Progress -->
    <div class="bg-blue-50 rounded-lg shadow p-6 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-blue-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
          <p class="text-3xl font-bold text-blue-900 mt-2">{{ in_progress_tickets }}</p>
        </div>
        <div class="text-4xl">üîß</div>
      </div>
    </div>

    <!-- Completed -->
    <div class="bg-green-50 rounded-lg shadow p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-green-800">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
          <p class="text-3xl font-bold text-green-900 mt-2">{{ completed_tickets }}</p>
        </div>
        <div class="text-4xl">‚úÖ</div>
      </div>
    </div>
  </div>

  <!-- Performance Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Avg Response Time -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm font-medium text-gray-600">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
      </div>
      <p class="text-2xl font-bold text-gray-800">{{ avg_response_hours }} ‡∏ä‡∏°.</p>
      <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á</p>
    </div>

    <!-- Avg Completion Time -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm font-medium text-gray-600">‚è≤Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
      </div>
      <p class="text-2xl font-bold text-gray-800">{{ avg_completion_hours }} ‡∏ä‡∏°.</p>
      <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
    </div>

    <!-- Average Rating -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm font-medium text-gray-600">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
      </div>
      <p class="text-2xl font-bold text-gray-800">{{ avg_overall_rating }}/5.0</p>
      <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≤‡∏Å {{ total_feedbacks }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Tickets by Status Chart -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Tickets by Status</h3>
      <canvas id="statusChart" class="max-h-64"></canvas>
    </div>

    <!-- Tickets by Category Chart -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Tickets by Category</h3>
      <canvas id="categoryChart" class="max-h-64"></canvas>
    </div>
  </div>

  <!-- Technician Performance Table -->
  <div class="bg-white rounded-lg shadow mb-8">
    <div class="p-6 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800">üë∑ ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for tech in technician_stats %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">{{ tech.name }}</div>
              <div class="text-xs text-gray-500">@{{ tech.username }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ tech.assigned }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ tech.completed }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                  <div class="bg-green-600 h-2 rounded-full" style="width: {{ tech.completion_rate }}%"></div>
                </div>
                <span class="text-sm font-medium text-gray-900">{{ tech.completion_rate }}%</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="text-sm font-medium text-yellow-600">‚≠ê {{ tech.avg_rating }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if tech.is_available %}
                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</span>
              {% else %}
                <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Tickets Table (Full Width) -->
  <div class="bg-white rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800">Tickets ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡πà‡∏≤‡∏á</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for ticket in recent_tickets %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#{{ ticket.id }}</td>
            <td class="px-6 py-4 text-sm text-gray-900">
              <a href="{% url 'tickets:ticket_detail' ticket.id %}" class="text-red-600 hover:text-red-800 hover:underline">
                {{ ticket.title|truncatewords:5 }}
              </a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ticket.category.name }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if ticket.status == 'PENDING' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
              {% elif ticket.status == 'IN_PROGRESS' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
              {% elif ticket.status == 'INSPECTING' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
              {% elif ticket.status == 'WORKING' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
              {% elif ticket.status == 'COMPLETED' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
              {% elif ticket.status == 'CLOSED' %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</span>
              {% else %}
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">{{ ticket.get_status_display }}</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ticket.created_by.get_display_name }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {% if ticket.assigned_to %}
                {{ ticket.assigned_to.get_display_name }}
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ticket.created_at|date:"d/m/Y" }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <div class="flex gap-2">
                <!-- Change Status Button -->
                {% if ticket.status != 'CLOSED' %}
                <button onclick="openStatusModal({{ ticket.id }}, '{{ ticket.status }}', '{{ ticket.title|escapejs }}')"
                        class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                  ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                </button>
                {% endif %}

                <!-- Close Ticket Button -->
                {% if ticket.status == 'COMPLETED' %}
                <button onclick="confirmCloseTicket({{ ticket.id }}, '{{ ticket.title|escapejs }}')"
                        class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition">
                  ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
                </button>
                {% elif ticket.status == 'CLOSED' %}
                <span class="text-xs text-gray-400">‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Activity (2 columns) -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

    <!-- Recent Feedback -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">üí¨ Feedback ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
      </div>
      <div class="divide-y divide-gray-200">
        {% for feedback in recent_feedbacks %}
        <div class="p-4 hover:bg-gray-50">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <a href="{% url 'tickets:ticket_detail' feedback.ticket.id %}" class="text-sm font-medium text-blue-600 hover:underline">
                Ticket #{{ feedback.ticket.id }}
              </a>
              <p class="text-xs text-gray-500">
                ‡∏ä‡πà‡∏≤‡∏á: {{ feedback.ticket.assigned_to.get_display_name }}
              </p>
            </div>
            <div class="text-right">
              <span class="text-sm font-bold text-yellow-600">‚≠ê {{ feedback.overall_rating }}/5</span>
              <p class="text-xs text-gray-500">{{ feedback.created_at|date:"d/m/Y" }}</p>
            </div>
          </div>
          {% if feedback.comment %}
          <p class="text-sm text-gray-600 italic">"{{ feedback.comment|truncatewords:15 }}"</p>
          {% endif %}
        </div>
        {% empty %}
        <div class="p-4 text-center text-sm text-gray-500">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Feedback
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- User Statistics -->
  <div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">üë• ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="text-center">
        <p class="text-3xl font-bold text-gray-800">{{ total_users }}</p>
        <p class="text-sm text-gray-600 mt-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
      </div>
      <div class="text-center">
        <p class="text-3xl font-bold text-blue-600">{{ total_technicians }}</p>
        <p class="text-sm text-gray-600 mt-1">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</p>
      </div>
      <div class="text-center">
        <p class="text-3xl font-bold text-green-600">{{ total_regular_users }}</p>
        <p class="text-sm text-gray-600 mt-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Parse data from Django
const statusData = {{ status_chart_data|safe }};
const categoryData = {{ category_chart_data|safe }};

// Status Chart (Pie)
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
  type: 'pie',
  data: {
    labels: statusData.labels,
    datasets: [{
      data: statusData.data,
      backgroundColor: [
        '#FCD34D', // Yellow - PENDING
        '#60A5FA', // Blue - IN_PROGRESS
        '#34D399', // Green - COMPLETED
        '#F87171', // Red - REJECTED
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'bottom',
      }
    }
  }
});

// Category Chart (Bar)
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
  type: 'bar',
  data: {
    labels: categoryData.labels,
    datasets: [{
      label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Tickets',
      data: categoryData.data,
      backgroundColor: '#3B82F6',
      borderColor: '#2563EB',
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        }
      }
    },
    plugins: {
      legend: {
        display: false
      }
    }
  }
});
</script>

<!-- Status Change Modal -->
<div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Ticket</h3>

      <p class="text-sm text-gray-600 mb-2">Ticket: <span id="modalTicketTitle" class="font-semibold"></span></p>

      <form id="statusChangeForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="ticket_id" id="modalTicketId">

        <div class="mb-4">
          <label for="new_status" class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</label>
          <select name="new_status" id="new_status" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà --</option>
            <option value="PENDING">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="IN_PROGRESS">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="INSPECTING">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
            <option value="WORKING">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="COMPLETED">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            <option value="REJECTED">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="admin_comment" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <textarea name="admin_comment" id="admin_comment" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"></textarea>
        </div>

        <div class="flex gap-3">
          <button type="button" onclick="closeStatusModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Close Ticket Confirmation Modal -->
<div id="closeTicketModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h3>

      <p class="text-sm text-gray-600 mb-4">
        ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô Ticket: <span id="closeTicketTitle" class="font-semibold"></span> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
      </p>
      <p class="text-xs text-gray-500 mb-4">
        ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô" ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
      </p>

      <form id="closeTicketForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="ticket_id" id="closeTicketId">
        <input type="hidden" name="action" value="close_ticket">

        <div class="flex gap-3">
          <button type="button" onclick="closeCloseTicketModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Status Change Modal Functions
  function openStatusModal(ticketId, currentStatus, ticketTitle) {
    document.getElementById('modalTicketId').value = ticketId;
    document.getElementById('modalTicketTitle').textContent = '#' + ticketId + ' - ' + ticketTitle;
    document.getElementById('statusModal').classList.remove('hidden');

    // Set form action
    document.getElementById('statusChangeForm').action = '{% url "dashboard:admin_change_status" %}';
  }

  function closeStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
    document.getElementById('statusChangeForm').reset();
  }

  // Close Ticket Modal Functions
  function confirmCloseTicket(ticketId, ticketTitle) {
    document.getElementById('closeTicketId').value = ticketId;
    document.getElementById('closeTicketTitle').textContent = '#' + ticketId + ' - ' + ticketTitle;
    document.getElementById('closeTicketModal').classList.remove('hidden');

    // Set form action
    document.getElementById('closeTicketForm').action = '{% url "dashboard:admin_close_ticket" %}';
  }

  function closeCloseTicketModal() {
    document.getElementById('closeTicketModal').classList.add('hidden');
    document.getElementById('closeTicketForm').reset();
  }

  // Close modals when clicking outside
  window.onclick = function(event) {
    const statusModal = document.getElementById('statusModal');
    const closeModal = document.getElementById('closeTicketModal');

    if (event.target === statusModal) {
      closeStatusModal();
    }
    if (event.target === closeModal) {
      closeCloseTicketModal();
    }
  }
</script>

{% endblock %}
