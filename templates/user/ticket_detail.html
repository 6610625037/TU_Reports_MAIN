{% extends 'base.html' %}
{% load static %}

{% block title %}Ticket #{{ ticket.id }} - TU Report{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4">
  <div class="mb-6">
    <a href="{% url 'tickets:my_tickets' %}" class="text-red-600 hover:text-red-800">&larr; กลับไปหน้างานของฉัน</a>
  </div>

  <!-- Ticket Header -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Ticket #{{ ticket.id }}</h1>
        <p class="text-sm text-gray-500 mt-1">สร้างเมื่อ {{ ticket.created_at|date:"d/m/Y H:i" }}</p>
      </div>
      <div class="text-right">
        {% if ticket.status == 'PENDING' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800">รอดำเนินการ</span>
        {% elif ticket.status == 'IN_PROGRESS' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">รับงานแล้ว</span>
        {% elif ticket.status == 'INSPECTING' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">กำลังตรวจสอบ</span>
        {% elif ticket.status == 'WORKING' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">กำลังดำเนินการ</span>
        {% elif ticket.status == 'COMPLETED' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">เสร็จสิ้น</span>
        {% elif ticket.status == 'CLOSED' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-100 text-gray-800">ปิดงาน</span>
        {% elif ticket.status == 'REJECTED' %}
          <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">ปฏิเสธ</span>
        {% endif %}

        <!-- Action Buttons for Owner -->
        {% if ticket.created_by == user %}
        <div class="mt-3 space-x-2">
          {% if ticket.status == 'PENDING' %}
            <a href="{% url 'tickets:edit_ticket' ticket.id %}"
               class="inline-block px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
              ✏️ แก้ไข
            </a>
          {% endif %}

          {% if ticket.status in 'PENDING,IN_PROGRESS,INSPECTING,WORKING' %}
            <a href="{% url 'tickets:cancel_ticket' ticket.id %}"
               class="inline-block px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
              ❌ ยกเลิก
            </a>
          {% endif %}

          {% if ticket.status in 'COMPLETED,CLOSED' %}
            <a href="{% url 'tickets:submit_feedback' ticket.id %}"
               class="inline-block px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700">
              ⭐ ให้คะแนน
            </a>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- รายละเอียดปัญหา (Full Width) -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">รายละเอียดปัญหา</h2>

    <div class="mb-4">
      <h3 class="text-lg font-semibold text-gray-800">{{ ticket.title }}</h3>
    </div>

    <div class="mb-4">
      <p class="text-gray-700 whitespace-pre-wrap">{{ ticket.description }}</p>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 border-t pt-4">
      <div>
        <label class="block text-sm font-medium text-gray-500">หมวดหมู่</label>
        <p class="mt-1 text-gray-900">{{ ticket.category.name }}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">ความเร่งด่วน</label>
        <p class="mt-1">
          {% if ticket.urgency_level == 'LOW' %}
            <span class="text-green-600">ต่ำ</span>
          {% elif ticket.urgency_level == 'MEDIUM' %}
            <span class="text-yellow-600">ปานกลาง</span>
          {% elif ticket.urgency_level == 'HIGH' %}
            <span class="text-orange-600">สูง</span>
          {% elif ticket.urgency_level == 'CRITICAL' %}
            <span class="text-red-600">วิกฤต</span>
          {% endif %}
        </p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">ผู้แจ้ง</label>
        <p class="mt-1 text-gray-900">{{ ticket.created_by.get_display_name }}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">ช่างรับผิดชอบ</label>
        <p class="mt-1 text-gray-900">
          {% if ticket.assigned_to %}
            {{ ticket.assigned_to.get_display_name }}
          {% else %}
            <span class="text-gray-400">ยังไม่มอบหมาย</span>
          {% endif %}
        </p>
      </div>
    </div>

    {% if ticket.address_description %}
    <div class="mt-4 border-t pt-4">
      <label class="block text-sm font-medium text-gray-500">สถานที่</label>
      <p class="mt-1 text-gray-900">{{ ticket.address_description }}</p>
    </div>
    {% endif %}
  </div>

  <!-- 2 Columns: Timeline (Left) + Photos (Right) -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Left Column: Status Timeline (แนวตั้ง) -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-6">สถานะ</h2>

      <div class="relative">
        <!-- Vertical Line -->
        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>

        <!-- Timeline Items -->
        <div class="space-y-6">
          {% for hist in history %}
          <div class="relative flex items-start">
            <!-- Circle Marker -->
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-500 flex items-center justify-center relative z-10">
              <svg class="h-4 w-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>

            <!-- Content -->
            <div class="ml-4 flex-1">
              <p class="text-sm font-semibold text-gray-900">
                {{ hist.get_new_status_display }}
              </p>
              <p class="text-xs text-gray-500 mt-1">
                {{ hist.changed_by.get_display_name }} • {{ hist.timestamp|date:"d/m/Y H:i" }}
              </p>
              {% if hist.comment %}
                <p class="text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded">{{ hist.comment }}</p>
              {% endif %}
            </div>
          </div>
          {% empty %}
          <p class="text-gray-500 text-center">ไม่มีประวัติ</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Right Column: Before/After Photos -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-6">รูปภาพ</h2>

      <!-- Before Photo -->
      {% if before_photo %}
      <div class="mb-6">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">รูป Before</h3>
        <img src="{{ before_photo.image.url }}" alt="Before Photo" class="w-full h-64 object-cover rounded-lg shadow">
        <p class="text-xs text-gray-500 mt-1">อัปโหลดโดย: {{ before_photo.uploaded_by.get_display_name }}</p>
      </div>
      {% endif %}

      <!-- After Photo -->
      {% if after_photo %}
      <div>
        <h3 class="text-sm font-semibold text-gray-700 mb-2">รูป After</h3>
        <img src="{{ after_photo.image.url }}" alt="After Photo" class="w-full h-64 object-cover rounded-lg shadow">
        <p class="text-xs text-gray-500 mt-1">อัปโหลดโดย: {{ after_photo.uploaded_by.get_display_name }}</p>
      </div>
      {% endif %}

      <!-- No Photos -->
      {% if not before_photo and not after_photo %}
      <div class="text-center text-gray-400 py-12">
        <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <p class="mt-2">ยังไม่มีรูปภาพ</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Technician Update Section (เฉพาะ technician ที่ได้รับมอบหมาย) -->
  {% if user.role == 'technician' and ticket.assigned_to == user and ticket.status not in 'COMPLETED,CLOSED,REJECTED' %}
  <div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-xl font-bold text-gray-800 mb-6">อัปเดตงาน</h2>

    <form method="POST" enctype="multipart/form-data" id="technicianUpdateForm">
      {% csrf_token %}

      <!-- Status Update Dropdown -->
      <div class="mb-4">
        <label for="new_status" class="block text-sm font-medium text-gray-700 mb-2">เปลี่ยนสถานะ</label>
        <select name="new_status" id="new_status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
          <option value="">-- เลือกสถานะใหม่ --</option>
          {% if ticket.status == 'PENDING' %}
            <option value="IN_PROGRESS">รับงานแล้ว</option>
          {% endif %}
          {% if ticket.status in 'PENDING,IN_PROGRESS' %}
            <option value="INSPECTING">กำลังตรวจสอบ</option>
          {% endif %}
          {% if ticket.status in 'PENDING,IN_PROGRESS,INSPECTING' %}
            <option value="WORKING">กำลังดำเนินการ</option>
          {% endif %}
        </select>
      </div>

      <!-- Comment/Note -->
      <div class="mb-4">
        <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
        <textarea name="comment" id="comment" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="ระบุรายละเอียดเพิ่มเติม (ถ้ามี)"></textarea>
      </div>

      <!-- Upload After Photo -->
      <div class="mb-6">
        <label for="after_photo" class="block text-sm font-medium text-gray-700 mb-2">
          อัพโหลดรูป After
          {% if not after_photo %}
          <span class="text-red-500">(จำเป็นสำหรับการส่งงาน)</span>
          {% endif %}
        </label>
        <input type="file" name="after_photo" id="after_photo" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" onchange="checkAfterPhoto()">
        {% if after_photo %}
        <p class="text-xs text-green-600 mt-1">✓ มีรูป After แล้ว</p>
        {% else %}
        <p class="text-xs text-gray-500 mt-1" id="no-after-message">ยังไม่มีรูป After</p>
        {% endif %}
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <!-- Update Status Button -->
        <button type="submit" name="action" value="update_status" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
          อัปเดตสถานะ
        </button>

        <!-- Submit Work Button (disabled until after photo exists) -->
        <button type="submit" name="action" value="submit_work" id="submitWorkBtn" class="flex-1 px-6 py-3 font-semibold rounded-lg transition {% if after_photo %}bg-green-600 text-white hover:bg-green-700{% else %}bg-gray-300 text-gray-500 cursor-not-allowed{% endif %}" {% if not after_photo %}disabled{% endif %}>
          ส่งงาน (เสร็จสิ้น)
        </button>
      </div>
    </form>
  </div>

  <script>
    function checkAfterPhoto() {
      const fileInput = document.getElementById('after_photo');
      const submitBtn = document.getElementById('submitWorkBtn');
      const noAfterMsg = document.getElementById('no-after-message');

      if (fileInput.files.length > 0) {
        // Enable submit work button
        submitBtn.disabled = false;
        submitBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        submitBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');

        // Update message
        if (noAfterMsg) {
          noAfterMsg.textContent = '✓ เลือกรูปแล้ว';
          noAfterMsg.classList.remove('text-gray-500');
          noAfterMsg.classList.add('text-green-600');
        }
      }
    }
  </script>
  {% endif %}

</div>
{% endblock %}
