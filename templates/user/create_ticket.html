{% extends 'base.html' %}
{% load static %}

{% block title %}‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ - TU Report{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h1>

  <form method="post" enctype="multipart/form-data" class="bg-white rounded-lg shadow p-6 space-y-6">
    {% csrf_token %}

    <!-- Title -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ *</label>
      {{ form.title }}
    </div>

    <!-- Category -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *</label>
      {{ form.category }}
    </div>

    <!-- Description -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *</label>
      {{ form.description }}
    </div>

    <!-- Urgency -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô *</label>
      {{ form.urgency_level }}
    </div>

    <!-- Address -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏´‡πâ‡∏≠‡∏á)</label>
      {{ form.address_description }}
    </div>

    <!-- GPS & Map -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ *</label>
      <button type="button" id="getGPS" class="mb-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        üéØ ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (GPS)
      </button>
      <div id="gpsStatus" class="text-sm text-gray-600 mb-2"></div>
      <div id="map" class="h-64 rounded-md border border-gray-300"></div>
      <input type="hidden" id="latitude" name="latitude" required>
      <input type="hidden" id="longitude" name="longitude" required>
      <p class="text-xs text-gray-500 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
    </div>

    <!-- Before Photo -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏° (Before Photo) *</label>
      <input type="file" name="before_photo" accept="image/*" required
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <p class="text-xs text-gray-500 mt-1">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)</p>
      <div id="photoPreview" class="mt-2"></div>
    </div>

    <!-- Submit -->
    <div class="flex justify-end space-x-3">
      <a href="{% url 'tickets:my_tickets' %}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </a>
      <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
        ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
      </button>
    </div>
  </form>
</div>

<!-- Leaflet JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Initialize map
  const map = L.map('map').setView([14.0708, 100.6057], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let marker;

  // GPS Auto-Capture
  document.getElementById('getGPS').addEventListener('click', function() {
    const status = document.getElementById('gpsStatus');
    status.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';

    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // Set coordinates
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        // Add/Move marker
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 17);

        status.innerHTML = '‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
        status.className = 'text-sm text-green-600 mb-2';
      },
      function(error) {
        status.innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
        status.className = 'text-sm text-red-600 mb-2';
      }
    );
  });

  // Click on map
  map.on('click', function(e) {
    if (marker) map.removeLayer(marker);
    marker = L.marker(e.latlng).addTo(map);
    document.getElementById('latitude').value = e.latlng.lat;
    document.getElementById('longitude').value = e.latlng.lng;
    document.getElementById('gpsStatus').innerHTML = '‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
    document.getElementById('gpsStatus').className = 'text-sm text-green-600 mb-2';
  });

  // Photo Preview
  document.querySelector('input[name="before_photo"]').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('photoPreview').innerHTML =
          '<img src="' + e.target.result + '" class="w-48 h-48 object-cover rounded border">';
      };
      reader.readAsDataURL(file);
    }
  });
</script>
{% endblock %}
